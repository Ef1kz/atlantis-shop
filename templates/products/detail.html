<!-- templates/products/detail.html -->
{% extends 'base.html' %}

{% block title %}{{ product.name }} — ATLANTIS{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Фото товара -->
        <div class="col-md-6">
            {% if product.image %}
            <img src="{{ product.image.url }}" class="img-fluid rounded shadow" alt="{{ product.name }}">
            {% else %}
            <img src="https://via.placeholder.com/600x600/222/FFD700?text={{ product.name|urlencode }}"
                 class="img-fluid rounded shadow"
                 alt="{{ product.name }}">
            {% endif %}
        </div>

        <!-- Информация о товаре -->
        <div class="col-md-6">
            <h1 class="display-5 fw-bold text-gold mb-4">{{ product.name }}</h1>

            <div class="mb-4">
                <span class="fs-3 text-gold fw-bold">{{ product.price }} ₽</span>

                {% if product.stock > 0 %}
                <span class="badge bg-success ms-3">В наличии</span>
                {% else %}
                <span class="badge bg-danger ms-3">Нет в наличии</span>
                {% endif %}
            </div>

            <p class="lead mb-4">{{ product.description }}</p>

            <p class="text-light mb-4">  <!-- ← Светлый цвет для категории -->
                Категория: <a href="{% url 'products:product_list_by_collection' product.category.slug %}" class="text-gold">{{ product.category.name }}</a>
            </p>

            <!-- Кнопки -->
            <div class="d-flex gap-3 mb-5">
                <button class="btn btn-action add-to-cart" data-product-id="{{ product.id }}">Добавить в корзину</button>
                <a href="{% url 'cart:detail' %}" class="btn btn-outline-gold">Перейти в корзину</a>
            </div>
        </div>
    </div>

    <!-- Блок отзывов -->
    <div class="mt-5">
        <h2 class="gold mb-4">Отзывы</h2>

        {% if reviews %}
        {% for review in reviews %}
        <div class="card bg-dark text-white mb-3">
            <div class="card-body">
                <p class="mb-1"><strong>{{ review.user.username }}</strong> — {{ review.created_at|date:"d.m.Y" }}</p>
                <p class="mb-1">Оценка:
                    {% for i in "12345" %}
                    {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                    {% endfor %}
                </p>
                <p>{{ review.comment }}</p>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-light">Пока нет отзывов. Будьте первым!</p>  <!-- ← Светлый -->
        {% endif %}

        <!-- Форма отзыва -->
        {% if user.is_authenticated %}
        {% if has_reviewed %}
        <p class="text-success">Вы уже оставили отзыв на этот товар.</p>
        {% elif review_form %}
        <button class="btn btn-gold mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#reviewForm">
            Оставить отзыв
        </button>

        <div class="collapse" id="reviewForm">
            <form method="post" action="{% url 'reviews:add_review' product.id %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label text-gold">Ваша оценка</label>
                    <div>{{ review_form.rating }}</div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-gold">Ваш отзыв</label>
                    {{ review_form.comment }}
                </div>
                <button type="submit" class="btn btn-action">Отправить отзыв</button>
            </form>
        </div>
        {% endif %}
        {% else %}
        <p class="text-light">Войдите в аккаунт, чтобы оставить отзыв.</p>  <!-- ← Светлый -->
        <a href="/accounts/login/?next={{ request.path|urlencode }}" class="btn btn-gold">Войти</a>
        {% endif %}
    </div>
</div>

<!-- JS для корзины -->
<script>
    async function updateCartCount() {
        try {
            const response = await fetch('/cart/count/');
            const data = await response.json();
            const counter = document.getElementById('cart-count');
            if (counter) counter.textContent = data.count;
        } catch (error) {
            console.error(error);
        }
    }

    document.querySelectorAll(".add-to-cart").forEach(button => {
        button.addEventListener("click", async () => {
            const productId = button.dataset.productId;
            const response = await fetch(
                "{% url 'cart:add' 0 %}".replace("0", productId),
                {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json"
                    }
                }
            );
            const data = await response.json();
            if (data.success) updateCartCount();
        });
    });

    updateCartCount();
</script>
{% endblock %}
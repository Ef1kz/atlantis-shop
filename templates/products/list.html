{% extends 'base.html' %}
{% load static %}

{% block title %}Каталог — ATLANTIS{% endblock %}

{% block content %}
<h1 class="section-title">
    {% if category_title %}
    {{ category_title }}
    {% else %}
    КАТАЛОГ ТОВАРОВ
    {% endif %}
</h1>

{% if products %}
<div class="row g-4">
    {% for product in products %}
    <div class="col-md-3">
        <div class="card bg-dark text-white h-100">

            {% if product.image %}
            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
            {% else %}
            <img src="https://via.placeholder.com/300x200/333/FFD700?text=No+Image"
                 class="card-img-top">
            {% endif %}

            <div class="card-body d-flex flex-column">
                <h5 class="card-title gold">{{ product.name }}</h5>
                <p class="card-text">Цена: {{ product.price }} ₽</p>
                <p class="card-text"><small>Коллекция: {{ product.collection.name }}</small></p>

                <button class="btn btn-gold add-to-cart mb-2"
                        data-product-id="{{ product.id }}">
                    Добавить в корзину
                </button>

                <a href="{% url 'products:product_detail' product.pk %}"
                   class="btn btn-detail">
                    Подробнее
                </a>
            </div>

        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center">
    <p class="lead">В этой категории пока нет товаров.</p>
    <a href="{% url 'products:product_list' %}" class="btn btn-gold">
        Весь каталог
    </a>
</div>
{% endif %}

<script>
    async function updateCartCount() {
        try {
            const response = await fetch("{% url 'cart:count' %}");
            const data = await response.json();

            const counter = document.getElementById('cart-count');
            if (counter) counter.textContent = data.count;

        } catch (error) {
            console.error(error);
        }
    }

    document.querySelectorAll(".add-to-cart").forEach(button => {

        button.addEventListener("click", async () => {

            const productId = button.dataset.productId;

            const response = await fetch(
                "{% url 'cart:add' 0 %}".replace("0", productId),
                {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json"
                    }
                }
            );

            const data = await response.json();

            if (data.success) updateCartCount();
        });

    });

    updateCartCount();
</script>

{% endblock %}

{% extends "admin/base_site.html" %}
{% load static admin_urls admin_list %}

{% block extrahead %}
{{ block.super }}



<meta name="csrf-token" content="{{ csrf_token }}">
<style>

        /* –î–µ–ª–∞–µ–º —Ñ–æ—Ä–º—É –≤—ã—Ö–æ–¥–∞ —Å—Ç—Ä–æ—á–Ω–æ–π, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞ –≤—Å—ë –≤–æ–∫—Ä—É–≥ */
    #logout-form {
      display: inline !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* –£–±–∏—Ä–∞–µ–º "–º–µ—Ä—Ç–≤—ã–µ –∑–æ–Ω—ã" —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    #user-tools {
      pointer-events: none !important; /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–∑—Ä–∞—á–µ–Ω –¥–ª—è –∫–ª–∏–∫–∞ */
    }

    #user-tools a,
    #user-tools button,
    #user-tools form {
      pointer-events: auto !important; /* –ê —Å–∞–º–∏ —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
    }

    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –∫–ª–∏–∫–∞ –¥–ª—è –º–µ–ª–∫–∏—Ö —Å—Å—ã–ª–æ–∫ */
    #user-tools a {
      padding: 10px 5px !important;
      margin: -10px 0 !important;
    }


  /* 1. –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ "–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏" –ø–æ–≤–µ—Ä—Ö –ª—é–±—ã—Ö —Å–ª–æ–µ–≤ */
.header-controls, .user-info, .kanban-header {
  position: relative !important;
  z-index: 9999 !important; /* –ü–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö */
  pointer-events: auto !important;
}

/* 2. –£–±–∏—Ä–∞–µ–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –Ω–µ–≤–∏–¥–∏–º—ã–º —Å–ª–æ–µ–º –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –≤–µ—Ä—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
.breadcrumbs {
  display: none !important;
}

/* 3. –ï—Å–ª–∏ –≤ —Ç–≤–æ–µ–π –≤–µ—Ä—Å–∏–∏ –∞–¥–º–∏–Ω–∫–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ #header —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π,
    –æ–Ω –º–æ–∂–µ—Ç "–Ω–∞–ø–æ–ª–∑–∞—Ç—å" –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –∫—Ä–∞–µ–º –Ω–∞ –∫–Ω–æ–ø–∫–∏ */
#header {
  z-index: 100 !important;
}

/* 4. –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–∞–µ–º –∫–Ω–æ–ø–∫–∞–º –æ–±–ª–∞—Å—Ç—å –Ω–∞–∂–∞—Ç–∏—è –ø–æ–±–æ–ª—å—à–µ (padding) */
.user-info a, .user-info button {
  display: inline-block;
  padding: 5px 2px;
  cursor: pointer;
}

/* 1. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞–∫–µ—Ç –¥–ª—è Kanban */
{% if current_view == 'kanban' %}
html, body { height: 100%; overflow: hidden; background: #0a0a0a; }
#container { height: 100%; display: flex; flex-direction: column; }
#content { flex: 1; display: flex; flex-direction: column; padding: 0 !important; overflow: hidden; }
#content h1 { display: none; }
{% endif %}

.kanban-wrapper { display: flex; flex-direction: column; height: 100%; background: #0f0f0f; }

.kanban-board {
  display: flex; gap: 20px; padding: 20px;
  overflow-x: auto; flex: 1; align-items: flex-start;
}

/* 2. –ö–æ–ª–æ–Ω–∫–∏ */
.kanban-col {
  min-width: 295px; width: 295px; flex-shrink: 0;
  background: #161616; border-radius: 12px;
  display: flex; flex-direction: column;
  max-height: calc(100vh - 140px); border: 1px solid #252525;
}

.col-header {
  padding: 15px 20px; background: #1e1e1e; border-radius: 12px 12px 0 0;
  display: flex; justify-content: space-between; border-bottom: 2px solid #333;
}

.kanban-tasks { padding: 12px; overflow-y: auto; flex: 1; min-height: 100px; }

/* 3. –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ */
.task-card {
  background: #222; margin-bottom: 12px; padding: 16px; border-radius: 10px;
  cursor: grab; border: 1px solid #333; transition: all 0.2s ease;
  position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}

.task-card:hover { transform: translateY(-3px); border-color: #f4a261; box-shadow: 0 8px 15px rgba(244, 162, 97, 0.1); }

.priority-badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 10px; font-weight: 800; text-transform: uppercase; margin-bottom: 8px;
}
.badge-high { background: #e63946; color: #fff; }
.badge-medium { background: #f4a261; color: #fff; }
.badge-low { background: #2a9d8f; color: #fff; }

.task-title { font-weight: 600; color: #fff; font-size: 15px; margin-bottom: 10px; }
.task-footer { display: flex; justify-content: space-between; font-size: 11px; color: #888; border-top: 1px solid #333; padding-top: 10px; }

/* 4. –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –ø–æ–ª—è */
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(4px);
  overflow-y: auto;  /* –í–∞–∂–Ω–æ: –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å –≤–µ—Å—å –º–æ–¥–∞–ª */
  padding: 20px 0;   /* –æ—Ç—Å—Ç—É–ø—ã —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
}
.modal-content {
  background: #1a1a1a;
  color: white;
  padding: 30px;
  border-radius: 15px;
  max-width: 620px;
  margin: 0 auto;  /* —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
  border: 1px solid #333;
  max-height: 90vh;  /* –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É */
  overflow-y: auto;  /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∫—Ä–æ–ª–ª –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
  display: flex;
  flex-direction: column;
}

.modal-buttons {
      margin-top: auto;  /* –ø—Ä–∏–∂–∏–º–∞–µ—Ç –∫ –Ω–∏–∑—É */
      padding-top: 20px;
      border-top: 1px solid #333;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      position: sticky;
      bottom: 0;
      background: #1a1a1a;  /* —Ñ–æ–Ω –∫–∞–∫ —É –º–æ–¥–∞–ª–∞ */
      padding: 15px 0;
  }

.modal-content select, .modal-content input, .modal-content textarea {
  width: 100% !important; box-sizing: border-box !important;
  background: #252525; border: 1px solid #444; color: white;
  padding: 10px 12px; border-radius: 6px; margin-top: 5px; font-size: 14px; min-height: 42px;
}

.modal-content textarea { min-height: 80px; resize: vertical; }

.fields-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }

.field-group { display: flex; flex-direction: column; }
.field-group label { font-size: 11px; color: #aaa; text-transform: uppercase; margin-bottom: 2px; }

.file-attach { display: flex; align-items: center; margin-top: 10px; gap: 10px; color: #aaa; }
.file-attach input { flex: 1; background: none; border: none; color: white; }

.comments-section { margin-top: 30px; border-top: 1px solid #333; padding-top: 15px; max-height: 300px; overflow-y: auto; }
.comments-section h4 { font-size: 13px; color: #f4a261; text-transform: uppercase; margin-bottom: 15px; }
.comment-item { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #333; }
.comment-header { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 8px; }
.comment-text { font-size: 13px; color: #ddd; white-space: pre-wrap; }
.comment-file { margin-top: 8px; font-size: 11px; color: #f4a261; display: block; text-decoration: none; }
.comment-file:hover { text-decoration: underline; }

.notify {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #28a745;           /* —è—Ä–∫–∏–π –∑–µ–ª—ë–Ω—ã–π (Bootstrap success) */
  color: white;
  padding: 14px 28px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
  opacity: 0;
  transition: opacity 0.4s ease, transform 0.3s ease;
  z-index: 9999;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 240px;
  transform: translateY(-20px);
}

.notify::before {
  content: "‚úì";
  font-size: 20px;
}

.notify.show {
  opacity: 1;
  transform: translateY(0);
}

.modal-content input[type="submit"] {
  background: #f4a261 !important;
  color: #000 !important;
  font-weight: bold !important;
  border: none !important;
  padding: 10px 20px !important;
  border-radius: 6px !important;
  cursor: pointer;
}

.modal-content input[type="submit"]:hover {
  opacity: 0.9;
}
</style>
{% endblock %}

{% block content %}
{% if current_view == 'kanban' %}
<div class="kanban-wrapper">
    <div class="kanban-board">
        {% for status, data in tasks_by_status.items %}
        <div class="kanban-col" data-status="{{ status }}">
            <div class="col-header">
                <span style="font-weight: bold; color: #fff;">{{ data.label }}</span>
                <span style="background: #2d2d2d; padding: 2px 8px; border-radius: 10px; font-size: 12px; color: #aaa;">{{ data.count }}</span>
            </div>
            <div class="kanban-tasks">
                {% for task in data.tasks %}
                <div class="task-card" data-id="{{ task.id }}" draggable="true" onclick="openEditModal({{ task.id }})">
                    <div class="priority-badge badge-{{ task.priority }}">{{ task.get_priority_display }}</div>
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-footer">
                        <span>üßë {{ task.assigned_to.username|default:"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}</span>
                        <span>üìÖ {{ task.due_date|date:"d.m.Y"|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <form id="editForm" enctype="multipart/form-data">
            <input type="hidden" id="m_id">
            <input type="text" id="m_title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required>
            <textarea id="m_desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." rows="3" style="margin-top:10px;"></textarea>

            <div class="fields-grid">
                <div class="field-group"><label>–°—Ç–∞—Ç—É—Å</label>
                    <select id="m_status">{% for v, l in status_choices %}<option value="{{v}}">{{l}}</option>{% endfor %}</select>
                </div>
                <div class="field-group"><label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                    <select id="m_user"><option value="">-- –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω --</option>{% for u in users_list %}<option value="{{u.id}}">{{u.username}}</option>{% endfor %}</select>
                </div>
                <div class="field-group"><label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <select id="m_priority">{% for v, l in priority_choices %}<option value="{{v}}">{{l}}</option>{% endfor %}</select>
                </div>
                <div class="field-group"><label>–°—Ä–æ–∫</label>
                    <input type="date" id="m_date">
                </div>
            </div>

            <div id="comments-section" class="comments-section"></div>

            <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px;">
                <label style="font-size:11px; color:#f4a261; text-transform:uppercase;">–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π + —Ñ–∞–π–ª</label>
                <textarea id="m_new_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="height:60px; min-height:60px;"></textarea>
                <div class="file-attach">
                    <span style="font-size:16px;">üìé</span>
                    <input type="file" id="m_file">
                </div>
            </div>

            <div class="modal-buttons">
                <button type="button" onclick="closeEditModal()" style="background:none; border:1px solid #444; color:#aaa; padding:10px 20px; border-radius:6px;">–û—Ç–º–µ–Ω–∞</button>
                <input type="submit" value="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" style="background:#f4a261; color:white; border:none; padding:10px 30px; border-radius:6px; font-weight:bold;">
            </div>
        </form>
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <form id="createForm" enctype="multipart/form-data">
            <h3 style="margin:0 0 15px 0; color:#f4a261;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h3>

            <input type="text" id="c_title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required>
            <textarea id="c_desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." rows="2" style="margin-top:10px;"></textarea>

            <div class="fields-grid">
                <div class="field-group"><label>–°—Ç–∞—Ç—É—Å</label>
                    <select id="c_status">{% for v, l in status_choices %}<option value="{{v}}">{{l}}</option>{% endfor %}</select>
                </div>
                <div class="field-group"><label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                    <select id="c_user"><option value="">-- –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω --</option>{% for u in users_list %}<option value="{{u.id}}">{{u.username}}</option>{% endfor %}</select>
                </div>
                <div class="field-group"><label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <select id="c_priority">{% for v, l in priority_choices %}<option value="{{v}}">{{l}}</option>{% endfor %}</select>
                </div>
                <div class="field-group"><label>–°—Ä–æ–∫</label>
                    <input type="date" id="c_date">
                </div>
            </div>

            <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px;">
                <label style="font-size:11px; color:#f4a261; text-transform:uppercase;">–ù–∞—á–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π + —Ñ–∞–π–ª</label>
                <textarea id="c_new_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="height:50px; min-height:50px;"></textarea>
                <div class="file-attach">
                    <span style="font-size:16px;">üìé</span>
                    <input type="file" id="c_file">
                </div>
            </div>

            <div class="modal-buttons">
                <button type="button" onclick="closeCreateModal()" style="background:none; border:1px solid #444; color:#aaa; padding:10px 20px; border-radius:6px;">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" style="background:#f4a261; color:white; border:none; padding:10px 30px; border-radius:6px; font-weight:bold;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
        </form>
    </div>
</div>

<!-- Notify -->
<div id="notify" class="notify"></div>

<!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 999;">
    <a href="#" onclick="openCreateModal()" style="background:#f4a261; padding: 12px 25px; border-radius: 50px; color:white; text-decoration:none; font-weight:bold; box-shadow: 0 4px 10px rgba(244,162,97,0.3);">+ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</a>
</div>

<script>
    function getCsrf() {
        return document.querySelector('meta[name="csrf-token"]').content;
    }

            function showNotify(msg) {
            const notify = document.getElementById('notify');
            notify.textContent = msg;
            notify.classList.remove('show');  // —Å–±—Ä–æ—Å
            void notify.offsetWidth;          // reflow –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
            notify.classList.add('show');
            setTimeout(() => notify.classList.remove('show'), 4000);
        }

    // ==================== EDIT MODAL ====================
    function openEditModal(id) {
        document.getElementById('editModal').style.display = 'block';
        document.getElementById('m_id').value = id;

        fetch(`${id}/detail/`, {
            method: 'GET',
            headers: {'X-CSRFToken': getCsrf()}
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                const t = res.task;
                document.getElementById('m_title').value = t.title;
                document.getElementById('m_desc').value = t.description;
                document.getElementById('m_status').value = t.status;
                document.getElementById('m_user').value = t.assigned_to || '';
                document.getElementById('m_priority').value = t.priority;
                document.getElementById('m_date').value = t.due_date || '';

                // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ JSON
                const commentsSection = document.getElementById('comments-section');
                commentsSection.innerHTML = '<h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>';
                if (t.comments.length === 0) {
                    commentsSection.innerHTML += '<p style="color:#888; font-style:italic;">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>';
                } else {
                    t.comments.forEach(c => {
                        let html = `<div class="comment-item">
                            <div class="comment-header">
                                <span>${c.author}</span>
                                <span>${c.date}</span>
                            </div>
                            <div class="comment-text">${c.text || ''}</div>`;
                        if (c.file_url) {
                            html += `<a href="${c.file_url}" target="_blank" class="comment-file">üìé –í–ª–æ–∂–µ–Ω–∏–µ: ${c.file_name || '—Ñ–∞–π–ª'}</a>`;
                        }
                        html += '</div>';
                        commentsSection.innerHTML += html;
                    });
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∏');
            }
        })
        .catch(err => {
            console.error('Fetch error:', err);
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        });
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        document.getElementById('m_new_comment').value = '';
        document.getElementById('m_file').value = '';
    }

    document.getElementById('editForm').onsubmit = function(e) {
        e.preventDefault();
        const id = document.getElementById('m_id').value;
        const fd = new FormData();

        fd.append('title', document.getElementById('m_title').value);
        fd.append('description', document.getElementById('m_desc').value);
        fd.append('status', document.getElementById('m_status').value);
        fd.append('assigned_to', document.getElementById('m_user').value);
        fd.append('priority', document.getElementById('m_priority').value);
        fd.append('due_date', document.getElementById('m_date').value);
        fd.append('new_comment', document.getElementById('m_new_comment').value);

        const fileInput = document.getElementById('m_file');
        if (fileInput.files[0]) {
            fd.append('comment_file', fileInput.files[0]);
        }

        fetch(`${id}/save_modal/`, {
            method: 'POST',
            body: fd,
            headers: {'X-CSRFToken': getCsrf()}
        })
        .then(response => response.json())
        .then(res => {
            if (res.success) {
                showNotify("–ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
                closeEditModal();
                setTimeout(() => location.reload(), 800);  // –î–∞–µ–º –≤—Ä–µ–º—è —É–≤–∏–¥–µ—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + (res.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
            }
        })
        .catch(err => {
            console.error("Save error:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É");
        });
    };

    // ==================== CREATE MODAL ====================
    function openCreateModal() {
        // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
        document.getElementById('c_title').value = '';
        document.getElementById('c_desc').value = '';
        document.getElementById('c_status').value = 'todo';
        document.getElementById('c_user').value = '';
        document.getElementById('c_priority').value = 'medium';
        document.getElementById('c_date').value = '';
        document.getElementById('c_new_comment').value = '';
        document.getElementById('c_file').value = '';
        document.getElementById('createModal').style.display = 'block';
    }

    function closeCreateModal() {
        document.getElementById('createModal').style.display = 'none';
    }

    document.getElementById('createForm').onsubmit = function(e) {
        e.preventDefault();
        const fd = new FormData();

        fd.append('title', document.getElementById('c_title').value);
        fd.append('description', document.getElementById('c_desc').value);
        fd.append('status', document.getElementById('c_status').value);
        fd.append('assigned_to', document.getElementById('c_user').value);
        fd.append('priority', document.getElementById('c_priority').value);
        fd.append('due_date', document.getElementById('c_date').value);
        fd.append('new_comment', document.getElementById('c_new_comment').value);

        const file = document.getElementById('c_file').files[0];
        if (file) fd.append('comment_file', file);

        fetch('create_modal/', {
            method: 'POST',
            body: fd,
            headers: {'X-CSRFToken': getCsrf()}
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                showNotify("–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!");
                closeCreateModal();
                setTimeout(() => location.reload(), 800);
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: " + (res.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
            }
        })
        .catch(err => {
            console.error("Create error:", err);
            alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.task-card').forEach(card => {
            card.draggable = true;
            card.ondragstart = e => {
                e.dataTransfer.setData('text/plain', card.dataset.id);
                card.style.opacity = '0.4';
            };
            card.ondragend = () => {
                card.style.opacity = '1';
            };
        });

        document.querySelectorAll('.kanban-tasks').forEach(tasksContainer => {
            tasksContainer.ondragover = e => e.preventDefault();

            tasksContainer.ondrop = e => {
                e.preventDefault();

                const id = e.dataTransfer.getData('text/plain');
                if (!id) return;

                const col = tasksContainer.closest('.kanban-col');
                const status = col.dataset.status;
                if (!status) return;

                // –û–¢–ü–†–ê–í–õ–Ø–ï–ú JSON, –∞ –Ω–µ FormData (–∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç views.py)
                fetch(`${id}/update_status/`, {
                    method: 'POST',
                    body: JSON.stringify({ status: status }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrf()
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.json().then(err => { throw err; });
                    }
                })
                .then(res => {
                    if (res.success) {
                        showNotify('–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –æ–±–Ω–æ–≤–ª—ë–Ω!');
                        setTimeout(() => location.reload(), 600);
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (res.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', err);
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                });
            };
        });
    });
</script>
{% else %}
<div style="padding: 20px;">
    <a href="?view=kanban" class="button" style="background:#f4a261">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ Kanban-–¥–æ—Å–∫—É</a>
    {{ block.super }}
</div>
{% endif %}
{% endblock %}
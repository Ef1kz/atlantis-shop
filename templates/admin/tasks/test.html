<!-- tasks/templates/tasks/test.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç AJAX –∑–∞–ø—Ä–æ—Å–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        #result {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .test-case h3 {
            margin-top: 0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üõ† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AJAX –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è Kanban</h1>

    <div class="test-case">
        <h3>1. –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:</h3>
        <div class="buttons">
            <button onclick="testGet()">‚úÖ Test GET /tasks/test/</button>
            <button onclick="testPostForm()">üìù Test POST FormData</button>
            <button onclick="testPostJSON()">üìä Test POST JSON</button>
        </div>
    </div>

    <div class="test-case">
        <h3>2. –¢–µ—Å—Ç –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏ (task_detail):</h3>
        <input type="number" id="taskId" placeholder="ID –∑–∞–¥–∞—á–∏" value="1" style="padding: 8px; margin-right: 10px;">
        <button onclick="testTaskDetail()">üîç –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</button>
    </div>

    <div class="test-case">
        <h3>3. –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (update_status):</h3>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <input type="number" id="updateTaskId" placeholder="ID –∑–∞–¥–∞—á–∏" value="1" style="padding: 8px;">
            <select id="newStatus" style="padding: 8px;">
                <option value="todo">–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option>
                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="review">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</option>
                <option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
            </select>
            <button onclick="testUpdateStatus()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        </div>
        <small>–≠—Ç–æ —ç–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –≤ Kanban</small>
    </div>

    <div class="test-case">
        <h3>4. –¢–µ—Å—Ç –∏–º–∏—Ç–∞—Ü–∏–∏ Kanban drag-and-drop:</h3>
        <button onclick="simulateKanbanDrag()">üéØ –ò–º–∏—Ç–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏</button>
        <small>–¢–æ—á–Ω–æ —Ç–∞–∫–æ–π –∂–µ –∑–∞–ø—Ä–æ—Å –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º Kanban</small>
    </div>

    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
    <div id="result">–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...</div>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
        <h3>üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</h3>
        <ol>
            <li>–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "Test GET /tasks/test/" - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å</li>
            <li>–ó–∞—Ç–µ–º "Test POST FormData" - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å</li>
            <li>–ï—Å–ª–∏ POST —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ "–ò–º–∏—Ç–∞—Ü–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏"</li>
            <li>–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12 ‚Üí Console)</li>
            <li>–ò —Ç–µ—Ä–º–∏–Ω–∞–ª Django (—Ç–∞–º –±—É–¥—É—Ç –ª–æ–≥–∏)</li>
        </ol>
    </div>
</div>

<script>
    const resultEl = document.getElementById('result');

    function logResult(data, title = '–†–µ–∑—É–ª—å—Ç–∞—Ç:') {
        resultEl.innerHTML = `<strong>${title}</strong>\n\n` + JSON.stringify(data, null, 2);
        console.log(title, data);
    }

    async function testGet() {
        try {
            const response = await fetch('/tasks/test/');
            const data = await response.json();
            logResult(data, '‚úÖ GET –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω:');
        } catch (error) {
            logResult({ error: error.message }, '‚ùå –û—à–∏–±–∫–∞ GET:');
        }
    }

    async function testPostForm() {
        try {
            const formData = new FormData();
            formData.append('status', 'in_progress');
            formData.append('test_field', 'test_value');

            const response = await fetch('/tasks/test/post/', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            logResult(data, '‚úÖ POST FormData —É—Å–ø–µ—à–µ–Ω:');
        } catch (error) {
            logResult({ error: error.message }, '‚ùå –û—à–∏–±–∫–∞ POST FormData:');
        }
    }

    async function testPostJSON() {
        try {
            const response = await fetch('/tasks/test/post/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status: 'in_progress',
                    test: 'json_value'
                })
            });

            const data = await response.json();
            logResult(data, '‚úÖ POST JSON —É—Å–ø–µ—à–µ–Ω:');
        } catch (error) {
            logResult({ error: error.message }, '‚ùå –û—à–∏–±–∫–∞ POST JSON:');
        }
    }

    async function testTaskDetail() {
        const taskId = document.getElementById('taskId').value;
        try {
            const response = await fetch(`/tasks/task/${taskId}/detail/`);
            const data = await response.json();
            logResult(data, `‚úÖ –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ #${taskId}:`);
        } catch (error) {
            logResult({ error: error.message }, '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π:');
        }
    }

    async function testUpdateStatus() {
        const taskId = document.getElementById('updateTaskId').value;
        const newStatus = document.getElementById('newStatus').value;

        try {
            // –ò–ú–ï–ù–ù–û –¢–ê–ö Kanban –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å!
            const formData = new FormData();
            formData.append('status', newStatus);

            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å:', {
                url: `/tasks/task/${taskId}/update_status/`,
                method: 'POST',
                body: formData
            });

            const response = await fetch(`/tasks/task/${taskId}/update_status/`, {
                method: 'POST',
                body: formData
            });

            // –°–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
            const responseText = await response.text();
            console.log('–û—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç):', responseText);

            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                logResult({
                    error: '–ù–µ–≤–µ—Ä–Ω—ã–π JSON –≤ –æ—Ç–≤–µ—Ç–µ',
                    responseText: responseText,
                    status: response.status
                }, `‚ùå –û—à–∏–±–∫–∞ JSON (—Å—Ç–∞—Ç—É—Å ${response.status}):`);
                return;
            }

            if (response.ok) {
                logResult(data, `‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ #${taskId} –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ "${newStatus}":`);
            } else {
                logResult(data, `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (—Å—Ç–∞—Ç—É—Å ${response.status}):`);
            }
        } catch (error) {
            logResult({
                error: error.message,
                taskId: taskId,
                newStatus: newStatus
            }, '‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:');
        }
    }

    async function simulateKanbanDrag() {
        // –¢–û–ß–ù–ê–Ø –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ Kanban
        const taskId = 4; // ID –∑–∞–¥–∞—á–∏ –∏–∑ –≤–∞—à–µ–≥–æ Kanban
        const newStatus = 'in_progress'; // –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

        try {
            const formData = new FormData();
            formData.append('status', newStatus);

            console.log('üöÄ –ò–º–∏—Ç–∞—Ü–∏—è Kanban drag-and-drop:');
            console.log('URL:', `/tasks/task/${taskId}/update_status/`);
            console.log('Method: POST');
            console.log('Data:', { status: newStatus });

            const response = await fetch(`/tasks/task/${taskId}/update_status/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            });

            const responseText = await response.text();
            console.log('üì® –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', responseText);

            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                resultEl.innerHTML = `
                    <strong>‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON!</strong>
                    <div style="color: red; margin-top: 10px;">
                        <strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}<br>
                        <strong>–û—Ç–≤–µ—Ç:</strong><br>
                        <pre>${responseText.substring(0, 500)}${responseText.length > 500 ? '...' : ''}</pre>
                    </div>
                `;
                return;
            }

            if (response.ok && data.success) {
                logResult(data, `‚úÖ Kanban –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω! –ó–∞–¥–∞—á–∞ #${taskId} -> "${newStatus}":`);
            } else {
                logResult(data, `‚ùå Kanban –∑–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è (—Å—Ç–∞—Ç—É—Å ${response.status}):`);
            }
        } catch (error) {
            logResult({
                error: error.message,
                details: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ç–µ—Ä–º–∏–Ω–∞–ª Django'
            }, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–∏—Ç–∞—Ü–∏–∏ Kanban:');
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    async function loadTasks() {
        try {
            const response = await fetch('/tasks/test/');
            const data = await response.json();
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, —Ç–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:', data);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('DOMContentLoaded', loadTasks);
</script>
</body>
</html>